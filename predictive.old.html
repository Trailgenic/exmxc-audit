<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Predictive EEI Dashboard | exmxc.ai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { background:#f9fafb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
      .tier-Platinum { color:#22c55e;font-weight:600; }
      .tier-Gold { color:#ca8a04;font-weight:600; }
      .tier-Silver { color:#6b7280;font-weight:600; }
      .tier-Bronze { color:#b45309;font-weight:600; }
      .tier-Obscure { color:#991b1b;font-weight:600; }
      .score-bar { height:6px;border-radius:9999px;background:linear-gradient(90deg,#dc2626,#facc15,#22c55e); }
    </style>
  </head>

  <body class="max-w-6xl mx-auto py-10 px-5">
    <h1 class="text-3xl font-bold text-center text-gray-900 mb-2">
      Predictive EEI Dashboard
    </h1>
    <p class="text-center text-gray-600 text-sm mb-6">
      Batch Entity Engineering<sup>™</sup> Index — future-weighted scoring
    </p>

    <!-- Summary -->
    <div id="summaryBox" class="bg-amber-50 border border-amber-200 rounded-xl p-5 mb-8 text-center shadow-sm hidden">
      <div id="avgScore" class="text-2xl font-semibold text-gray-900 mb-1"></div>
      <div id="avgTier" class="text-sm font-medium text-gray-700"></div>
    </div>

    <!-- Run Button -->
    <div class="text-center mb-8">
      <button id="runBatch" class="bg-black text-white text-sm px-5 py-2 rounded-lg hover:bg-gray-800 transition">
        Run Predictive Batch
      </button>
    </div>

    <!-- Results Table -->
    <div class="overflow-x-auto">
      <table id="resultsTable" class="min-w-full bg-white border border-gray-200 rounded-xl shadow-sm text-sm">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="py-2 px-3 text-left">#</th>
            <th class="py-2 px-3 text-left">Domain</th>
            <th class="py-2 px-3 text-center">EEI</th>
            <th class="py-2 px-3 text-center">Tier</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="4" class="text-center py-6 text-gray-500">Awaiting batch run…</td></tr>
        </tbody>
      </table>
    </div>

    <footer class="text-center text-xs text-gray-500 mt-10">
      Powered by <span class="font-semibold text-black">exmxc.ai</span> | Entity Engineering<sup>™</sup> Predictive Audit
    </footer>

    <script>
      const runButton = document.getElementById("runBatch");
      const tableBody = document.getElementById("tableBody");
      const summaryBox = document.getElementById("summaryBox");
      const avgScore = document.getElementById("avgScore");
      const avgTier = document.getElementById("avgTier");

      async function runPredictive() {
        runButton.disabled = true;
        runButton.textContent = "Running Batch…";
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-6 text-gray-500">Processing 25 sites…</td></tr>`;
        summaryBox.classList.add("hidden");

        try {
          const res = await fetch("/api/predictive-audit");
          const data = await res.json();

          if (!data.results || data.results.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-6 text-gray-500">No data returned</td></tr>`;
            return;
          }

          // Summary
          const avg = Math.round(data.avgEntityScore || 0);
          avgScore.textContent = `Average EEI: ${avg} / 100`;
          avgTier.textContent = `${data.results.length} Entities | Dataset: ${data.dataset || "Unknown"}`;
          summaryBox.classList.remove("hidden");

          // Table
          tableBody.innerHTML = "";
          data.results.forEach((r, i) => {
            const tier = r.entityTier || "Unknown";
            const score = r.entityScore || 0;
            const tierClass = "tier-" + tier.split(" ")[0];
            const row = document.createElement("tr");
            row.className = "border-t border-gray-200 hover:bg-gray-50 transition";
            row.innerHTML = `
              <td class="py-2 px-3 text-gray-500">${i + 1}</td>
              <td class="py-2 px-3 text-blue-700"><a href="${r.url}" target="_blank" rel="noopener">${r.hostname || r.url}</a></td>
              <td class="py-2 px-3 text-center">${score}</td>
              <td class="py-2 px-3 text-center ${tierClass}">${tier}</td>`;
            tableBody.appendChild(row);
          });
        } catch (err) {
          tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-6 text-red-600">Error: ${err.message}</td></tr>`;
        } finally {
          runButton.disabled = false;
          runButton.textContent = "Re-Run Batch";
        }
      }

      runButton.addEventListener("click", runPredictive);
    </script>
  </body>
</html>
