<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ECI Diagnostic Console — Internal</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background-color: #f9fafb;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .json-box {
      background-color: #020617;
      color: #e2e8f0;
      padding: 1rem;
      border-radius: 0.75rem;
      font-size: 0.8rem;
      white-space: pre-wrap;
      overflow-x: auto;
    }
    .badge {
      font-size: 0.7rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-weight: 600;
    }
  </style>
</head>

<body class="max-w-6xl mx-auto py-10 px-5">

<!-- HEADER -->
<header class="mb-8">
  <div class="flex justify-between items-start">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">
        ECI Diagnostic Console <span class="text-xs text-gray-500">INTERNAL</span>
      </h1>
      <p class="text-sm text-gray-600 mt-1">
        exmxc.ai · Entity Clarity Index — structural truth view
      </p>
    </div>
    <div class="text-xs text-gray-500 text-right">
      <div>Powered by <strong>exmxc.ai</strong></div>
      <div id="timestamp"></div>
    </div>
  </div>
</header>

<!-- INPUT -->
<section class="bg-white border rounded-xl p-4 mb-6 shadow-sm">
  <label class="text-xs text-gray-600">URL to audit</label>
  <div class="flex gap-2 mt-1">
    <input id="urlInput" class="flex-1 border rounded px-3 py-2 text-sm" placeholder="example.com" />
    <button id="runButton" class="bg-black text-white px-4 py-2 rounded">Run Audit</button>
  </div>
</section>

<!-- ECI OVERVIEW -->
<section class="bg-indigo-50 border border-indigo-200 rounded-xl p-6 mb-8">
  <div class="flex justify-between items-start gap-6">

    <div>
      <div id="entityName" class="text-sm font-semibold text-gray-800"></div>

      <div class="flex items-center gap-3 mt-1">
        <div id="eciScore" class="text-3xl font-bold">ECI: —</div>
        <span id="eciBadge" class="badge bg-gray-200">—</span>
      </div>

      <div class="w-full h-3 bg-gray-200 rounded-full mt-3">
        <div id="eciBar" class="h-3 rounded-full"></div>
      </div>

      <div class="mt-3 text-sm">
        <div><strong>Interpretation:</strong> <span id="eciInterpretation"></span></div>
        <div><strong>Strategic Posture:</strong> <span id="eciPosture"></span></div>
      </div>
    </div>

    <!-- CRAWL HEALTH -->
    <div class="bg-white border rounded-lg p-3 w-64 text-xs">
      <div class="flex justify-between items-center mb-1">
        <span class="font-semibold">Crawl Health</span>
        <span id="crawlHealthScore" class="badge bg-gray-200">—</span>
      </div>
      <div id="crawlHealthCategory" class="text-xs mb-1">—</div>
      <ul id="crawlHealthNotes" class="list-disc pl-4 space-y-0.5"></ul>
    </div>

  </div>
</section>

<!-- 13 SIGNALS (SINGLE SOURCE OF TRUTH) -->
<section class="mb-10">
  <h2 class="text-sm font-semibold mb-4">Entity Clarity Signals (13)</h2>

  <div class="bg-white border rounded-xl p-4">
    <div id="signalList" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"></div>
  </div>
</section>

<!-- RAW JSON -->
<section>
  <h2 class="text-sm font-semibold mb-2">Raw JSON (Diagnostic)</h2>
  <pre id="result" class="json-box">// Awaiting input…</pre>
</section>

<script>
const runButton = document.getElementById("runButton");
const resultEl = document.getElementById("result");
const timestampEl = document.getElementById("timestamp");

const entityNameEl = document.getElementById("entityName");
const eciScoreEl = document.getElementById("eciScore");
const eciBarEl = document.getElementById("eciBar");
const eciBadgeEl = document.getElementById("eciBadge");
const eciInterpretationEl = document.getElementById("eciInterpretation");
const eciPostureEl = document.getElementById("eciPosture");

const crawlHealthScoreEl = document.getElementById("crawlHealthScore");
const crawlHealthCategoryEl = document.getElementById("crawlHealthCategory");
const crawlHealthNotesEl = document.getElementById("crawlHealthNotes");

const signalListEl = document.getElementById("signalList");

function color(score) {
  if (score >= 80) return "bg-green-500";
  if (score >= 60) return "bg-yellow-400";
  if (score >= 40) return "bg-orange-400";
  return "bg-red-500";
}

function renderSignal(signal) {
  const div = document.createElement("div");
  div.className = "border rounded p-3";
  div.innerHTML = `
    <div class="flex justify-between items-center">
      <span class="font-medium">${signal.name}</span>
      <span class="badge ${
        signal.status === "Strong" ? "bg-green-100 text-green-800" :
        signal.status === "Moderate" ? "bg-yellow-100 text-yellow-800" :
        "bg-gray-200 text-gray-700"
      }">${signal.status}</span>
    </div>
  `;
  return div;
}

runButton.onclick = async () => {
  const input = document.getElementById("urlInput").value.trim();
  if (!input) return;

  resultEl.textContent = "Loading…";
  signalListEl.innerHTML = "";

  const url = input.startsWith("http") ? input : `https://${input}`;

  try {
    const res = await fetch(
      `/api/audit?url=${encodeURIComponent(url)}`,
      { headers: { "x-exmxc-key": "exmxc-internal" } }
    );

    const data = await res.json();
    resultEl.textContent = JSON.stringify(data, null, 2);
    timestampEl.textContent = `Last run: ${new Date().toLocaleString()}`;

    if (!data.success) return;

    const eci = data.eci;

    entityNameEl.textContent = `Entity: ${eci.entity.name}`;
    eciScoreEl.textContent = `ECI: ${eci.eci.score} / 100`;
    eciBarEl.style.width = `${eci.eci.score}%`;
    eciBarEl.className = `h-3 rounded-full ${color(eci.eci.score)}`;

    eciBadgeEl.textContent = eci.eci.range;
    eciBadgeEl.className = "badge bg-indigo-100 text-indigo-800";

    eciInterpretationEl.textContent = eci.eci.interpretation;
    eciPostureEl.textContent = eci.eci.strategicPosture;

    // Signals (defensive)
if (Array.isArray(eci.claritySignals)) {
  eci.claritySignals.forEach(sig => {
    signalListEl.appendChild(renderSignal(sig));
  });
} else {
  const div = document.createElement("div");
  div.className = "text-xs text-gray-500";
  div.textContent = "Clarity signals unavailable for this crawl.";
  signalListEl.appendChild(div);
}


    // Crawl Health (diagnostic only)
    const ch = data.eei?.crawlHealth || {};
    crawlHealthScoreEl.textContent = ch.score ? `${ch.score}/100` : "—";
    crawlHealthCategoryEl.textContent = ch.category || "—";
    crawlHealthNotesEl.innerHTML = "";
    (ch.notes || []).forEach(n => {
      const li = document.createElement("li");
      li.textContent = n;
      crawlHealthNotesEl.appendChild(li);
    });

  } catch (err) {
    resultEl.textContent = JSON.stringify({ success: false, error: err.message }, null, 2);
  }
};
</script>

</body>
</html>
