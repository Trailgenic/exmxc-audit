<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>exmxc.ai Audit</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #fafafa;
        max-width: 900px;
        margin: 40px auto;
        text-align: center;
        color: #111;
      }

      input {
        width: 70%;
        padding: 10px;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 6px;
      }

      button {
        padding: 10px 16px;
        font-size: 1rem;
        margin-left: 8px;
        background: #111;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      button:hover {
        background: #333;
      }

      button:disabled {
        background: #999;
        cursor: not-allowed;
      }

      pre {
        background: #f4f4f4;
        padding: 20px;
        text-align: left;
        overflow-x: auto;
        border-radius: 8px;
        margin-top: 25px;
        font-size: 0.9rem;
      }

      .error {
        background: #fee;
        border: 1px solid #fcc;
        color: #c00;
      }

      .success {
        background: #efe;
        border: 1px solid #cfc;
      }
    </style>
  </head>

  <body>
    <h1>exmxc.ai Audit</h1>
    <p>Enter a URL to audit:</p>
    <input id="urlInput" type="text" placeholder="https://example.com" />
    <button id="runButton">Run Audit</button>
    <pre id="result"></pre>

    <script>
      const runButton = document.getElementById("runButton");
      const urlInput = document.getElementById("urlInput");
      const resultEl = document.getElementById("result");

      runButton.addEventListener("click", async () => {
        const input = urlInput.value.trim();
        
        if (!input) {
          resultEl.className = "error";
          resultEl.textContent = JSON.stringify({ error: "Please enter a URL" }, null, 2);
          return;
        }

        resultEl.className = "";
        resultEl.textContent = "Loading...";
        runButton.disabled = true;

        try {
          const url = input.startsWith("http") ? input : `https://${input}`;
          const res = await fetch(`/api/audit?url=${encodeURIComponent(url)}`);
          
          // Check if response is actually JSON
          const contentType = res.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            const text = await res.text();
            resultEl.className = "error";
            resultEl.textContent = JSON.stringify({
              error: "Server returned non-JSON response",
              response: text.substring(0, 500)
            }, null, 2);
            return;
          }

          const data = await res.json();
          
          if (data.success) {
            resultEl.className = "success";
          } else {
            resultEl.className = "error";
          }
          
          resultEl.textContent = JSON.stringify(data, null, 2);
          
        } catch (err) {
          resultEl.className = "error";
          resultEl.textContent = JSON.stringify({ 
            error: "Request failed", 
            details: err.message 
          }, null, 2);
        } finally {
          runButton.disabled = false;
        }
      });

      // Allow Enter key to trigger audit
      urlInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          runButton.click();
        }
      });
    </script>
  </body>
</html>
