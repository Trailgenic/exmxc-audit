<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>EEI Internal Audit</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root {
  --bg:#050914;
  --panel:#0b1224;
  --border:#1e2a4a;
  --text:#e6ebff;
  --muted:#9aa4c7;
  --accent:#4f7cff;
  --active:#1f3b8a;
}

* { box-sizing:border-box; }

body {
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:radial-gradient(circle at top,#0a1024,#030611);
  color:var(--text);
}

.container {
  max-width:1200px;
  margin:40px auto;
  padding:0 20px;
}

h1 { margin-bottom:14px; }

.input-row {
  display:flex;
  gap:12px;
  margin-bottom:22px;
}

input {
  flex:1;
  padding:14px 16px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--panel);
  color:var(--text);
}

button {
  padding:14px 22px;
  border-radius:10px;
  border:none;
  background:linear-gradient(135deg,#4f7cff,#6f9bff);
  color:white;
  font-weight:600;
  cursor:pointer;
}

.panel {
  background:linear-gradient(180deg,#0b1224,#060b1c);
  border:1px solid var(--border);
  border-radius:14px;
  padding:20px;
}

.top-grid {
  display:grid;
  grid-template-columns:1.2fr 1fr;
  gap:20px;
  margin-bottom:20px;
}

/* QUADRANT */
.quadrant {
  position:relative;
  height:360px;
  display:grid;
  grid-template-columns:1fr 1fr;
  grid-template-rows:1fr 1fr;
  gap:10px;
}

.quad {
  border:1px dashed var(--border);
  border-radius:12px;
  padding:30px 16px 16px;
  font-size:14px;
}

.quad.active {
  border:2px solid var(--accent);
  background:rgba(79,124,255,0.08);
}

.quad strong { display:block; margin-bottom:6px; }

.center-score {
  position:absolute;
  top:47%;
  left:50%;
  transform:translate(-50%,-50%);
  width:120px;
  height:120px;
  border-radius:50%;
  background:#060b1c;
  border:2px solid var(--accent);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:5;
}

.center-score span {
  font-size:34px;
  font-weight:700;
}

/* STRATEGY */
.strategy h3 { margin-top:0; }

ul { padding-left:18px; }

details { margin-top:16px; }

details summary {
  cursor:pointer;
  font-weight:600;
}

pre {
  background:#020617;
  padding:14px;
  border-radius:10px;
  font-size:12px;
  overflow-x:auto;
}
</style>
</head>

<body>
<div class="container">
  <h1>EEI Internal Audit</h1>

  <div class="input-row">
    <input id="urlInput" placeholder="example.com" />
    <button id="runBtn">Run Audit</button>
  </div>

  <div id="results" style="display:none;">
    <div class="top-grid">

      <!-- QUADRANT -->
      <div class="panel">
        <div class="quadrant">
          <div id="q-ai" class="quad">
            <strong>üöÄ AI-First Leader</strong>
            High Capability ¬∑ High Intent
          </div>
          <div id="q-sovereign" class="quad">
            <strong>üè∞ Sovereign / Defensive Power</strong>
            High Capability ¬∑ Low Intent
          </div>
          <div id="q-aspire" class="quad">
            <strong>üå± Aspirational Challenger</strong>
            Medium Capability ¬∑ High Intent
          </div>
          <div id="q-cautious" class="quad">
            <strong>‚öñÔ∏è Cautious Optimizer</strong>
            Medium Capability ¬∑ Medium Intent
          </div>

          <div class="center-score">
            <span id="score">‚Äì</span>
            <small>Capability</small>
          </div>
        </div>
      </div>

      <!-- STRATEGY -->
      <div class="panel strategy">
        <h3>Strategy ‚Äî Pros / Cons</h3>
        <div id="strategyBox"></div>
      </div>
    </div>

    <!-- INTENT SIGNALS -->
    <div class="panel">
      <strong>AI Intent Signals (Observed)</strong>
      <ul id="signals"></ul>
    </div>

   <!-- EVIDENCE -->
<details class="panel">
  <summary>View Evidence</summary>
  <pre id="evidence"></pre>
</details>

<!-- RAW JSON -->
<details class="panel">
  <summary>Raw JSON (Internal)</summary>
  <pre id="raw"></pre>
</details>
</div>
</div>

<script>
const runBtn = document.getElementById("runBtn");
const results = document.getElementById("results");

function clearActive() {
  document.querySelectorAll(".quad").forEach(q =>
    q.classList.remove("active")
  );
}

/* -----------------------------
   SCORE-ONLY EVIDENCE FORMATTER
------------------------------ */
function renderEvidence(breakdown = []) {
  return breakdown.map(b => {
    const key = b?.key || "Unknown";
    const pts = Number.isFinite(b?.points) ? b.points : 0;
    const max = Number.isFinite(b?.max) ? b.max : 0;
    const notes = (b?.notes || "").trim();
    return `${key} ‚Äî ${pts}/${max}${notes ? ` ‚Äî ${notes}` : ""}`;
  }).join("\n");
}

/* -----------------------------
   HARD UI TIMEOUT FETCH (CRITICAL)
------------------------------ */
function fetchWithTimeout(url, options = {}, timeoutMs = 9000) {
  return Promise.race([
    fetch(url, options),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error("UI_TIMEOUT")), timeoutMs)
    )
  ]);
}

runBtn.onclick = async () => {
  const url = document.getElementById("urlInput").value.trim();
  if (!url) return;

  runBtn.disabled = true;
  runBtn.textContent = "Running‚Ä¶";
  results.style.display = "none";

  let data;

  try {
    const res = await fetchWithTimeout(
      `/api/audit?url=${encodeURIComponent(url)}`,
      {},
      9000
    );

    if (!res || !res.ok) {
      throw new Error("FETCH_FAILED");
    }

    data = await res.json();

  } catch (err) {
    // HARD FAIL-FAST ‚Äî NEVER HANG UI
    alert("Audit blocked or timed out.\nClassified as LOW intent.");
    return;

  } finally {
    // GUARANTEED UI RESET
    runBtn.disabled = false;
    runBtn.textContent = "Run Audit";
  }

  /* -----------------------------
     RENDER RESULTS
  ------------------------------ */
  document.getElementById("score").textContent = data.ecc.score;

  clearActive();
  if (data.quadrant.includes("AI-First"))
    document.getElementById("q-ai").classList.add("active");
  else if (data.quadrant.includes("Sovereign"))
    document.getElementById("q-sovereign").classList.add("active");
  else if (data.quadrant.includes("Aspirational"))
    document.getElementById("q-aspire").classList.add("active");
  else
    document.getElementById("q-cautious").classList.add("active");

  document.getElementById("signals").innerHTML =
    (data.intent.signals || [])
      .map(s => `<li>${s}</li>`)
      .join("");

  // ‚úÖ View Evidence = SCORE ONLY
  document.getElementById("evidence").textContent =
    renderEvidence(data.breakdown || []);

  // ‚úÖ Raw JSON = FULL PAYLOAD
  document.getElementById("raw").textContent =
    JSON.stringify(data, null, 2);

  document.getElementById("strategyBox").innerHTML = `
    <strong>Pros</strong>
    <ul>
      <li>Structural authority and control</li>
      <li>Resilient to platform volatility</li>
    </ul>
    <strong>Cons</strong>
    <ul>
      <li>AI-native challengers can flank</li>
      <li>Discovery leverage underutilized</li>
    </ul>
    <em>
      Capability: ${data.ecc.band.toUpperCase()}
      ¬∑ Intent: ${data.intent.posture.toUpperCase()}
    </em>
  `;

  results.style.display = "block";
};
</script>
</body>
</html>
