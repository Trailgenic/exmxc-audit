<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EEI Public Entity Audit</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background-color: #f9fafb;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
      Arial, sans-serif;
    }
  </style>
</head>

<body class="max-w-6xl mx-auto py-10 px-5">

  <!-- HEADER -->
  <header class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900 text-center mb-2">
      EEI Public Entity Audit
    </h1>
    <p class="text-sm text-gray-600 text-center max-w-3xl mx-auto">
      This public view shows your Unified EEI score, tier summary,
      crawl diagnostics, and interpretation ranges.
      Raw diagnostics, schema analysis, and ontology alignment are reserved
      for exmxc internal audits.
    </p>
  </header>

  <!-- INPUT PANEL -->
  <section class="bg-white border border-gray-200 rounded-xl p-4 mb-6 shadow-sm">
    <div class="flex flex-col md:flex-row md:items-center gap-3">
      <div class="flex-1">
        <label for="urlInput"
               class="block text-xs font-semibold text-gray-700 mb-1">
          URL to audit
        </label>
        <input id="urlInput"
               type="text"
               placeholder="example.com"
               class="border border-gray-300 rounded-lg px-3 py-2 w-full text-sm focus:ring-2 focus:ring-black focus:outline-none" />
      </div>
      <div class="flex-shrink-0 pt-1">
        <button id="runButton"
                class="bg-black text-white text-sm px-5 py-2 rounded-lg hover:bg-gray-800 transition shadow-sm">
          Run Audit
        </button>
      </div>
    </div>
    <p class="text-xs text-gray-500 mt-2">
      Uses <code>/api/audit</code> with current Unified EEI logic.
      Public view hides full diagnostics, schema, and ontology details.
    </p>
  </section>

  <!-- SCORE CARD -->
  <section id="scoreCard"
           class="bg-amber-50 border border-amber-200 rounded-xl p-6 mb-8 shadow-sm hidden">

    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
      <!-- LEFT -->
      <div class="flex-1">
        <div class="text-xs text-gray-600 mb-1"
             id="entityLabel">Entity:</div>

        <div class="flex items-center gap-3 mb-2">
          <div class="text-3xl font-bold text-gray-900">
            <span id="scoreValue">--</span>
            <span class="text-lg font-semibold text-gray-500">/ 100</span>
          </div>
          <span id="microBadge"
                class="inline-flex items-center px-3 py-1 rounded-full text-[11px] font-semibold bg-emerald-50 text-emerald-700 border border-emerald-200">
            EEI status
          </span>
        </div>

        <!-- BIG SCORE BAR -->
        <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden mb-3">
          <div id="scoreBar"
               class="h-3 rounded-full"
               style="width:0%;
                background:linear-gradient(
                  90deg,#dc2626 0%,#facc15 40%,#22c55e 80%)">
          </div>
        </div>

        <!-- STAGE -->
        <div class="flex items-center gap-2 mb-1">
          <div id="stageIcon" class="text-base" aria-hidden="true">ðŸŒ‘</div>
          <div class="text-sm font-semibold text-gray-900"
               id="stageLabel">â€”</div>
          <button id="stageVerb"
                  class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold bg-gray-900 text-white">
            â€”
          </button>
        </div>

        <p id="stageDescription"
           class="text-sm text-gray-700 mt-1 max-w-2xl">
          â€”
        </p>
        <p id="stageFocus"
           class="text-xs text-gray-500 mt-1 max-w-2xl">
        </p>
      </div>

      <!-- RIGHT: CRAWL HEALTH -->
      <div class="w-full md:w-64 bg-white border border-amber-200 rounded-xl p-4 flex flex-col gap-1">
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs font-semibold text-gray-700">
            Crawl Health
          </span>
          <span class="text-[10px] text-gray-400 uppercase tracking-wide">
            beta
          </span>
        </div>
        <div class="text-sm text-gray-900"
             id="crawlCategory">â€”</div>
        <div class="text-xs text-gray-500"
             id="crawlNotes">
          Experimental view of crawler accessibility.
        </div>
      </div>
    </div>
  </section>

  <!-- TIER SUMMARY -->
  <section class="mb-10 hidden" id="tierSection">
    <h2 class="text-lg font-semibold text-gray-900 mb-3">
      Tier Summary
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

      <!-- Tier Card Template -->
      <!-- Tier 1 -->
      <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex flex-col">
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs font-semibold text-gray-700">Tier 1</span>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-gray-100 text-gray-700">
            Entity comprehension & trust
          </span>
        </div>
        <div class="text-sm text-gray-900 mb-1">
          <span id="tier1Score">0.0</span>
          <span class="text-gray-500">/ 100</span>
        </div>
        <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden mb-1">
          <div id="tier1Bar"
               class="h-2 rounded-full bg-amber-400"
               style="width:0%">
          </div>
        </div>
        <div class="text-[11px] text-gray-500"
             id="tier1Raw">Raw 0 / 0</div>
      </div>

      <!-- Tier 2 -->
      <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex flex-col">
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs font-semibold text-gray-700">Tier 2</span>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-gray-100 text-gray-700">
            Structural data fidelity
          </span>
        </div>
        <div class="text-sm text-gray-900 mb-1">
          <span id="tier2Score">0.0</span>
          <span class="text-gray-500">/ 100</span>
        </div>
        <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden mb-1">
          <div id="tier2Bar"
               class="h-2 rounded-full bg-emerald-500"
               style="width:0%">
          </div>
        </div>
        <div class="text-[11px] text-gray-500"
             id="tier2Raw">Raw 0 / 0</div>
      </div>

      <!-- Tier 3 -->
      <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex flex-col">
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs font-semibold text-gray-700">Tier 3</span>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-gray-100 text-gray-700">
            Page-level hygiene
          </span>
        </div>
        <div class="text-sm text-gray-900 mb-1">
          <span id="tier3Score">0.0</span>
          <span class="text-gray-500">/ 100</span>
        </div>
        <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden mb-1">
          <div id="tier3Bar"
               class="h-2 rounded-full bg-emerald-500"
               style="width:0%">
          </div>
        </div>
        <div class="text-[11px] text-gray-500"
             id="tier3Raw">Raw 0 / 0</div>
      </div>

    </div>
  </section>

  <!-- INTERPRETATION + SIGNALS REMAIN UNCHANGED -->
  <!-- (not repeating due to space; we keep your original) -->
  <!-- ... same interpretation table ... -->
  <!-- ... same signals list ... -->

  <!-- SCRIPT -->
  <script>
    const runButton = document.getElementById("runButton");
    const scoreCard = document.getElementById("scoreCard");
    const tierSection = document.getElementById("tierSection");

    const entityLabel = document.getElementById("entityLabel");
    const scoreValue = document.getElementById("scoreValue");
    const microBadge = document.getElementById("microBadge");
    const scoreBar = document.getElementById("scoreBar");

    const stageIcon = document.getElementById("stageIcon");
    const stageLabel = document.getElementById("stageLabel");
    const stageVerb = document.getElementById("stageVerb");
    const stageDescription = document.getElementById("stageDescription");
    const stageFocus = document.getElementById("stageFocus");

    const crawlCategory = document.getElementById("crawlCategory");
    const crawlNotes = document.getElementById("crawlNotes");

    const tier1Score = document.getElementById("tier1Score");
    const tier1Bar = document.getElementById("tier1Bar");
    const tier1Raw = document.getElementById("tier1Raw");
    const tier2Score = document.getElementById("tier2Score");
    const tier2Bar = document.getElementById("tier2Bar");
    const tier2Raw = document.getElementById("tier2Raw");
    const tier3Score = document.getElementById("tier3Score");
    const tier3Bar = document.getElementById("tier3Bar");
    const tier3Raw = document.getElementById("tier3Raw");

    function normalizeUrl(input) {
      let url = (input || "").trim();
      if (!url) return null;
      if (!/^https?:\/\//i.test(url)) url = `https://${url}`;
      try { return new URL(url).toString(); } catch { return null; }
    }

    function microStateLabel(score) {
      if (score >= 80) return "Trusted sovereign entity";
      if (score >= 70) return "Stable structured entity";
      if (score >= 60) return "Fragile structure";
      if (score >= 50) return "Visible but untrusted";
      if (score >= 40) return "Weakly visible";
      return "Unstructured / low visibility";
    }

    function stageEmoji(stageText) {
      if (!stageText) return "ðŸŒ‘";
      if (stageText.includes("Sovereign")) return "â˜€ï¸";
      if (stageText.includes("Structured")) return "ðŸŒ•";
      if (stageText.includes("Visible")) return "ðŸŒ—";
      return "ðŸŒ‘";
    }

    runButton.addEventListener("click", async () => {
      const normalized = normalizeUrl(document.getElementById("urlInput").value);
      if (!normalized) return alert("Please enter a valid URL.");
      runButton.disabled = true;
      runButton.textContent = "Running...";

      try {
        const res = await fetch(`/api/audit?url=${encodeURIComponent(normalized)}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.error || "Audit failed.");

        // SCORE
        const unifiedScore = data?.unified?.entityScore ?? 0;
        scoreValue.textContent = unifiedScore;
        microBadge.textContent = microStateLabel(unifiedScore);
        scoreBar.style.width = `${unifiedScore}%`;

        const entityName = data?.unified?.surfaces?.[0]?.entityName ||
                           data?.primary?.entityName ||
                           "Unknown entity";
        entityLabel.textContent = `Entity: ${entityName}`;

        // STAGE
        stageLabel.textContent = data?.unified?.entityStage || "";
        stageIcon.textContent = stageEmoji(stageLabel.textContent);
        stageVerb.textContent = data?.unified?.entityVerb || "";
        stageDescription.textContent = data?.unified?.entityDescription || "";
        stageFocus.textContent = data?.unified?.entityFocus || "";

        // CRAWL HEALTH
        const ch = data?.primary?.crawlHealth || {};
        crawlCategory.textContent = ch.category || "â€”";
        crawlNotes.textContent = (ch.notes && ch.notes[0]) ||
          "Experimental view of crawler accessibility.";

        scoreCard.classList.remove("hidden");

        // TIERS
        const tiers = data?.primary?.tierScores || {};
        function fillTier(tier, elScore, elBar, elRaw) {
          const n = tier?.normalized ?? 0;
          const raw = tier?.raw ?? 0;
          const max = tier?.maxWeight ?? 0;
          elScore.textContent = n.toFixed(1);
          elBar.style.width = `${Math.min(n, 100)}%`;
          elRaw.textContent = `Raw ${raw} / ${max}`;
        }

        fillTier(tiers.tier1, tier1Score, tier1Bar, tier1Raw);
        fillTier(tiers.tier2, tier2Score, tier2Bar, tier2Raw);
        fillTier(tiers.tier3, tier3Score, tier3Bar, tier3Raw);

        tierSection.classList.remove("hidden");

      } catch (err) {
        alert(err.message);
      } finally {
        runButton.disabled = false;
        runButton.textContent = "Run Audit";
      }
    });
  </script>

</body>
</html>
