<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EEI Batch Visibility Audit — Analyst Mode</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#f7f7fb; font-family: system-ui, -apple-system, Segoe UI; }
    .card { background:white; border-radius:14px; padding:18px; border:1px solid #e5e7eb; }
    .pill { background:#f3f4f6; padding:6px 10px; border-radius:999px; font-size:12px; display:flex; gap:6px; align-items:center; }
    .state.observed { color:#065f46; background:#ecfdf5; padding:4px 8px; border-radius:6px; }
    .state.suppressed { color:#92400e; background:#fffbeb; padding:4px 8px; border-radius:6px; }
    .state.failed { color:#991b1b; background:#fef2f2; padding:4px 8px; border-radius:6px; }
    .json-box { background:#020617; color:#e5e7eb; border-radius:12px; padding:14px; white-space:pre-wrap; }
  </style>
</head>

<body class="max-w-6xl mx-auto py-10 px-5">

  <h1 class="text-3xl font-bold text-gray-900 text-center mb-1">
    EEI Batch Visibility Audit (Analyst Mode)
  </h1>
  <p class="text-center text-gray-500 mb-8">
    Static-first visibility mapping for industry reporting
  </p>

  <!-- ===== SUMMARY ===== -->
  <div id="summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>

  <!-- ===== DATASET RUNNER ===== -->
  <div class="card mb-8 flex flex-col md:flex-row gap-3 items-center">
    <div class="flex-1 w-full">
      <label class="block text-xs font-semibold text-gray-500 mb-1">Dataset</label>
      <select id="datasetSelect" class="w-full border rounded-lg px-3 py-2 text-sm">
        <option>Loading…</option>
      </select>
    </div>

    <button id="runBtn"
      class="bg-black text-white px-5 py-2 rounded-lg w-full md:w-48">
      Run Batch
    </button>

    <div id="runStatus" class="text-xs text-gray-500 text-center w-full md:w-32">&nbsp;</div>
  </div>

  <!-- ===== SUPPRESSION BREAKDOWN ===== -->
  <div class="card mb-8">
    <h2 class="font-semibold mb-3 text-gray-800">Suppression Breakdown</h2>
    <div id="suppressionRow" class="flex flex-wrap gap-2"></div>
  </div>

  <!-- ===== RESULTS TABLE ===== -->
  <h2 class="font-semibold mb-2 text-gray-800">Visibility Results</h2>

  <div class="card mb-6 overflow-auto">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50 border-b">
        <tr>
          <th class="px-3 py-2 text-left">URL</th>
          <th class="px-3 py-2 text-left">State</th>
          <th class="px-3 py-2 text-left">Suppression</th>
          <th class="px-3 py-2 text-left">ECC</th>
          <th class="px-3 py-2 text-left">Mode</th>
        </tr>
      </thead>
      <tbody id="resultsBody" class="divide-y"></tbody>
    </table>
  </div>

  <!-- ===== RAW JSON TOGGLE ===== -->
  <button id="jsonToggle"
    class="text-sm underline text-gray-600 mb-2">
    Show Raw JSON
  </button>

  <pre id="jsonBlock" class="json-box hidden">// Waiting for batch…</pre>


<script>
const datasetSelect = document.getElementById("datasetSelect");
const runBtn = document.getElementById("runBtn");
const runStatus = document.getElementById("runStatus");
const summary = document.getElementById("summary");
const suppressionRow = document.getElementById("suppressionRow");
const resultsBody = document.getElementById("resultsBody");
const jsonToggle = document.getElementById("jsonToggle");
const jsonBlock = document.getElementById("jsonBlock");

jsonToggle.addEventListener("click", () => {
  jsonBlock.classList.toggle("hidden");
  jsonToggle.textContent =
    jsonBlock.classList.contains("hidden")
      ? "Show Raw JSON"
      : "Hide Raw JSON";
});

/* Load datasets */
async function loadDatasets() {
  try {
    const res = await fetch("/api/verticals");
    const data = await res.json();
    datasetSelect.innerHTML = "";
    data.verticals.forEach(v => {
      const o = document.createElement("option");
      o.value = v.value;
      o.textContent = v.label || v.value;
      datasetSelect.appendChild(o);
    });
  } catch {
    datasetSelect.innerHTML = "<option value='core-web'>core-web</option>";
  }
}
loadDatasets();

/* Run batch */
runBtn.addEventListener("click", async () => {
  const dataset = datasetSelect.value;
  runStatus.textContent = "Running…";

  const res = await fetch(`/api/batch-run?dataset=${dataset}`);
  const data = await res.json();

  jsonBlock.textContent = JSON.stringify(data, null, 2);
  runStatus.textContent = "Completed";

  renderSummary(data.summary, data.dataset);
  renderSuppression(data.suppressionBreakdown || {});
  renderTable(data.results || []);
});

/* UI Renders */
function renderSummary(s, dataset) {
  summary.innerHTML = `
    ${card("Dataset", dataset)}
    ${card("Sites", s.totalUrls)}
    ${card("Observed", s.observed, "bg-emerald-50")}
    ${card("Suppressed", s.suppressed, "bg-amber-50")}
    ${card("Opaque", s.opaque, "bg-gray-100")}
    ${card("Failed", s.failed, "bg-rose-50")}
    ${card("Observed Avg ECC", s.avgEntityScore)}
  `;
}

function card(label,val,extra=""){ return `
  <div class="card ${extra}">
    <div class="text-xs text-gray-500 mb-1">${label}</div>
    <div class="text-xl font-semibold">${val ?? "—"}</div>
  </div>`;}

function renderSuppression(obj){
  suppressionRow.innerHTML="";
  const keys = Object.keys(obj);
  if(!keys.length){ suppressionRow.innerHTML="<span class='text-gray-400 text-sm'>No suppression reasons detected</span>"; return;}
  keys.forEach(k=>{
    suppressionRow.innerHTML+=`<div class="pill"><span>${k}</span><strong>${obj[k]}</strong></div>`;
  });
}

function renderTable(rows){
  resultsBody.innerHTML="";
  if(!rows.length){
    resultsBody.innerHTML="<tr><td colspan='5' class='py-3 text-center text-gray-400'>No results</td></tr>";
    return;
  }
  rows.forEach(r=>{
    resultsBody.innerHTML += `
      <tr>
        <td class="px-3 py-2"><a href="${r.url}" target="_blank" class="text-blue-600 underline">${r.url}</a></td>
        <td class="px-3 py-2"><span class="state ${r.state}">${r.state}</span></td>
        <td class="px-3 py-2">${r.suppression?.reason || "—"}</td>
        <td class="px-3 py-2">${r.entityScore?.toFixed?.(2) ?? "—"}</td>
        <td class="px-3 py-2">${r.mode || "static"}</td>
      </tr>`;
  });
}
</script>

</body>
</html>
