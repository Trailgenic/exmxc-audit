<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EEI Batch Visibility Audit — v7 Strategic UI</title>

<style>
  body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;
    background:#f7f8fb;color:#111;margin:0;padding:32px}
  .wrap{max-width:1100px;margin:0 auto}
  h1{margin:0 0 4px;font-weight:700}
  .sub{color:#666;margin-bottom:24px}
  .card{background:#fff;border-radius:14px;padding:20px;
    box-shadow:0 4px 10px rgba(0,0,0,.06);margin-bottom:20px}
  .row{display:flex;gap:14px}
  .cell{flex:1;background:#f9fafb;border:1px solid #eee;
    border-radius:10px;padding:14px;text-align:center}
  .label{font-size:12px;color:#666;margin-bottom:4px}
  .value{font-size:22px;font-weight:700}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px 8px;font-size:13px}
  th{color:#555;text-align:left;border-bottom:1px solid #e5e5e5}
  tr:hover{background:#fafafa}
  .mono{font-family:Menlo,Consolas,monospace;font-size:12px}
  .tag{padding:4px 8px;border-radius:10px;font-size:12px;display:inline-block}
  .open{background:#e5fbef;color:#076c3c}
  .defensive{background:#fff2c8;color:#8a5b00}
  .blocked{background:#ffe5e5;color:#9a1a1a}
  .cap-high{background:#e6f1ff;color:#114c9a}
  .cap-med{background:#fff3da;color:#8a6200}
  .cap-low{background:#ffe6e6;color:#9a1a1a}
</style>
</head>

<body>
<div class="wrap">

<h1>EEI Batch Visibility Audit — v7</h1>
<div class="sub">Static-first crawl posture • ECC capability banding</div>

<div class="card" id="summaryBox">
  <div class="row">
    <div class="cell">
      <div class="label">DATASET</div>
      <div class="value" id="datasetName">—</div>
    </div>
    <div class="cell">
      <div class="label">SITES</div>
      <div class="value" id="countSites">0</div>
    </div>
    <div class="cell">
      <div class="label">OPEN</div>
      <div class="value" id="countOpen">0</div>
    </div>
    <div class="cell">
      <div class="label">DEFENSIVE</div>
      <div class="value" id="countDefensive">0</div>
    </div>
    <div class="cell">
      <div class="label">BLOCKED</div>
      <div class="value" id="countBlocked">0</div>
    </div>
    <div class="cell">
      <div class="label">FAILED</div>
      <div class="value" id="countFailed">0</div>
    </div>
    <div class="cell">
      <div class="label">AVG ECC</div>
      <div class="value" id="avgECC">0.00</div>
    </div>
    <div class="cell">
      <div class="label">LAST RUN</div>
      <div class="value" id="lastRun">—</div>
    </div>
  </div>
</div>

<div class="card">
  <div class="label" style="margin-bottom:6px">DATASET</div>
  <select id="datasetSelect" style="padding:8px 10px;border-radius:10px;border:1px solid #ccc">
    <option value="tg-strategic">TG Strategic</option>
  </select>
  <button id="runBtn"
    style="margin-left:10px;padding:8px 14px;border-radius:10px;border:none;
    background:#000;color:#fff;cursor:pointer">Run Batch</button>
</div>

<div class="card">
  <h3 style="margin:0 0 8px">Strategic Posture + Capability</h3>

  <table id="resultsTable">
    <thead>
      <tr>
        <th>URL</th>
        <th>Posture</th>
        <th>ECC</th>
        <th>Capability</th>
        <th>Mode</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const els={
  datasetName:document.getElementById("datasetName"),
  countSites:document.getElementById("countSites"),
  countOpen:document.getElementById("countOpen"),
  countDefensive:document.getElementById("countDefensive"),
  countBlocked:document.getElementById("countBlocked"),
  countFailed:document.getElementById("countFailed"),
  avgECC:document.getElementById("avgECC"),
  lastRun:document.getElementById("lastRun"),
  tableBody:document.querySelector("#resultsTable tbody"),
  runBtn:document.getElementById("runBtn"),
  sel:document.getElementById("datasetSelect")
};

/* ============================
   Capability banding
============================ */
function capBand(score){
  if(score>=80) return {label:"High", cls:"cap-high"};
  if(score>=60) return {label:"Medium", cls:"cap-med"};
  return {label:"Low", cls:"cap-low"};
}

/* ============================
   Posture badge
============================ */
function postureTag(state){
  const s=(state||"").toLowerCase();
  if(s==="open") return `<span class="tag open">Open</span>`;
  if(s==="defensive") return `<span class="tag defensive">Defensive</span>`;
  if(s==="blocked") return `<span class="tag blocked">Blocked</span>`;
  return `<span class="tag blocked">Failed</span>`;
}

/* ============================
   Load vertical list from API
============================ */
async function loadVerticals(){
  try{
    const res = await fetch("/api/verticals");
    const data = await res.json();

    els.sel.innerHTML = "";

    (data.verticals || []).forEach(v=>{
      const opt=document.createElement("option");
      opt.value=v.value;
      opt.textContent=v.label || v.value;
      els.sel.appendChild(opt);
    });

    // restore last selection if valid
    const saved = localStorage.getItem("eei:lastDataset");
    if(saved && (data.verticals||[]).some(v=>v.value===saved)){
      els.sel.value = saved;
    }

  } catch(err){
    console.warn("Failed to load /api/verticals — fallback to core-web", err);
    els.sel.innerHTML = `<option value="core-web">Core Web</option>`;
  }
}

loadVerticals();

/* ============================
   Run Batch (v7)
============================ */
async function runBatch(){
  els.runBtn.textContent="Running…";
  els.runBtn.disabled=true;

  const ds = els.sel.value || "core-web";
  localStorage.setItem("eei:lastDataset", ds);

  const resp = await fetch(`/api/batch-run?dataset=${ds}`);
  const data = await resp.json();

  els.datasetName.textContent = data.dataset || ds;
  els.countSites.textContent = (data.results||[]).length;
  els.lastRun.textContent =
    data.timestamp ? new Date(data.timestamp).toLocaleString() : "—";

  let open=0,defensive=0,blocked=0,failed=0,totalECC=0,scored=0;
  els.tableBody.innerHTML="";

  (data.results||[]).forEach(r=>{
    if(r.success===false){ failed++; return; }

    const ecc = Number(r.ecc ?? r?._raw?.ecc?.score ?? 0);
    if(ecc>0){ totalECC+=ecc; scored++; }

    const st=(r.state||"").toLowerCase();
    if(st==="open") open++;
    else if(st==="defensive") defensive++;
    else if(st==="blocked") blocked++;
    else failed++;

    const cap=capBand(ecc);

    const row=document.createElement("tr");
    row.innerHTML=`
      <td class="mono"><a href="${r.url}" target="_blank">${r.url}</a></td>
      <td>${postureTag(st)}</td>
      <td>${ecc.toFixed(0)}</td>
      <td><span class="tag ${cap.cls}">${cap.label}</span></td>
      <td>${r.mode||"static"}</td>
    `;
    els.tableBody.appendChild(row);
  });

  els.countOpen.textContent=open;
  els.countDefensive.textContent=defensive;
  els.countBlocked.textContent=blocked;
  els.countFailed.textContent=failed;
  els.avgECC.textContent=scored? (totalECC/scored).toFixed(2) : "0.00";

  els.runBtn.textContent="Run Batch";
  els.runBtn.disabled=false;
}

els.runBtn.onclick=runBatch;
</script>


</div>
</body>
</html>
