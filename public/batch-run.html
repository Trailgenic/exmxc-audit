<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EEI Batch Visibility Audit</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body{background:#f8fafc}
  .pill{padding:2px 8px;border-radius:12px;font-size:12px}
  .pill.observed{background:#dcfce7;color:#065f46}
  .pill.suppressed{background:#fef9c3;color:#854d0e}
  .pill.opaque{background:#f1f5f9;color:#475569}
  .pill.failed{background:#fee2e2;color:#7f1d1d}
  .json-box{background:#020617;color:#e5e7eb;border-radius:10px;padding:14px;font-size:12px}
  details summary{cursor:pointer;color:#2563eb}
</style>
</head>

<body class="max-w-6xl mx-auto px-6 py-10">

<h1 class="text-3xl font-bold text-center mb-1">EEI Batch Visibility Audit (v6.6)</h1>
<p class="text-center text-gray-500 mb-8">Static-first visibility mapping across entities</p>

<!-- SUMMARY GRID -->
<div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-8">
  <div class="bg-white border rounded-xl p-4 shadow-sm">
    <div class="text-xs text-gray-500 uppercase mb-1">Dataset</div>
    <div id="datasetLabel" class="font-semibold text-gray-900">—</div>
  </div>

  <div class="bg-white border rounded-xl p-4 shadow-sm">
    <div class="text-xs text-gray-500 uppercase mb-1">Sites</div>
    <div id="siteTotal" class="font-semibold text-gray-900">—</div>
  </div>

  <div class="bg-white border rounded-xl p-4 shadow-sm">
    <div class="text-xs text-gray-500 uppercase mb-1">Observed</div>
    <div id="observedCount" class="font-semibold text-emerald-700">—</div>
  </div>

  <div class="bg-white border rounded-xl p-4 shadow-sm">
    <div class="text-xs text-gray-500 uppercase mb-1">Suppressed</div>
    <div id="suppressedCount" class="font-semibold text-amber-700">—</div>
  </div>

  <div class="bg-white border rounded-xl p-4 shadow-sm">
    <div class="text-xs text-gray-500 uppercase mb-1">Observed Avg ECC</div>
    <div id="observedAvgECC" class="font-semibold text-gray-900">—</div>
  </div>
</div>

<!-- CONTROLS -->
<div class="flex flex-col md:flex-row gap-3 items-center mb-8 bg-white border rounded-xl p-5 shadow-sm">
  <div class="flex-1 w-full">
    <label class="text-xs text-gray-600 uppercase mb-1 block">Dataset</label>
    <select id="datasetSelect" class="w-full border rounded-lg px-3 py-2 text-sm bg-white"></select>
  </div>

  <div class="md:w-44 w-full">
    <button id="runBtn" class="w-full bg-black text-white rounded-lg py-2 text-sm hover:bg-gray-800">
      Run Batch
    </button>
    <div id="status" class="text-xs text-gray-500 text-center mt-1">&nbsp;</div>
  </div>
</div>

<!-- RESULTS -->
<div class="grid md:grid-cols-2 gap-6">

  <div>
    <div class="text-lg font-semibold mb-2">Visibility Results</div>
    <div class="border rounded-xl bg-white shadow-sm max-h-[520px] overflow-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 sticky top-0">
        <tr>
          <th class="px-3 py-2 text-left">URL</th>
          <th class="px-3 py-2">State</th>
          <th class="px-3 py-2">Suppression</th>
          <th class="px-3 py-2">ECC</th>
          <th class="px-3 py-2">Mode</th>
        </tr>
        </thead>
        <tbody id="resultsBody" class="divide-y"></tbody>
      </table>
    </div>
  </div>

  <div>
    <details>
      <summary class="mb-2">Show Raw JSON</summary>
      <pre id="rawBox" class="json-box">// Awaiting run…</pre>
    </details>
  </div>
</div>

<script>
const datasetSelect = document.getElementById("datasetSelect");
const runBtn = document.getElementById("runBtn");
const statusEl = document.getElementById("status");
const rawBox = document.getElementById("rawBox");
const resultsBody = document.getElementById("resultsBody");

const datasetLabel = document.getElementById("datasetLabel");
const siteTotal = document.getElementById("siteTotal");
const observedCount = document.getElementById("observedCount");
const suppressedCount = document.getElementById("suppressedCount");
const observedAvgECC = document.getElementById("observedAvgECC");

/* ================ LOAD DATASETS ================= */
async function loadDatasets(){
  try{
    const res = await fetch("/api/verticals");
    const data = await res.json();
    datasetSelect.innerHTML = "";
    data.verticals.forEach(v=>{
      const opt = document.createElement("option");
      opt.value = v.value;
      opt.textContent = v.label || v.value;
      datasetSelect.appendChild(opt);
    });
  } catch {
    datasetSelect.innerHTML="<option value='core-web'>core-web</option>";
  }
}
loadDatasets();

/* ================ HELPERS ================= */
function pill(state){
  return `<span class="pill ${state}">${state}</span>`;
}

function renderTable(rows){
  resultsBody.innerHTML="";

  if(!rows?.length){
    resultsBody.innerHTML =
      `<tr><td colspan="5" class="text-center py-3 text-gray-400">No results</td></tr>`;
    return;
  }

  rows.forEach(r=>{
    const state =
      r?.visibility?.state?.value ??
      r?.visibility?.state ??
      r?.state?.value ??
      r?.state ??
      "—";

    const suppression =
      r?.visibility?.suppression?.reason ??
      r?.suppression?.reason ??
      "—";

    const ecc =
      typeof r?.entityScore === "number"
        ? r.entityScore.toFixed(2)
        : "—";

    const mode =
      r?.schemaMeta?.rendered ? "rendered" : "static";

    resultsBody.innerHTML += `
      <tr>
        <td class="px-3 py-2">
          <a href="${r.url}" target="_blank" class="text-blue-600 underline">${r.url}</a>
        </td>
        <td class="px-3 py-2 text-center">${pill(state)}</td>
        <td class="px-3 py-2 text-center">${suppression}</td>
        <td class="px-3 py-2 text-center">${ecc}</td>
        <td class="px-3 py-2 text-center">${mode}</td>
      </tr>`;
  });
}

/* ================ SUMMARY ================= */
function updateSummary(data){
  datasetLabel.textContent = data.dataset;
  siteTotal.textContent = data.totalUrls;

  const observed = data.results.filter(r =>
    (r?.visibility?.state?.value ?? r?.state) === "observed"
  );

  const suppressed = data.results.filter(r =>
    (r?.visibility?.state?.value ?? r?.state) === "suppressed"
  );

  observedCount.textContent = observed.length;
  suppressedCount.textContent = suppressed.length;

  const eccVals = observed
    .map(r => r.entityScore)
    .filter(n => typeof n === "number");

  observedAvgECC.textContent =
    eccVals.length
      ? (eccVals.reduce((a,b)=>a+b,0)/eccVals.length).toFixed(2)
      : "—";
}

/* ================ RUN BATCH ================= */
runBtn.addEventListener("click", async ()=>{
  const dataset = datasetSelect.value;
  statusEl.textContent = "Running…";

  const res = await fetch(`/api/batch-run?dataset=${dataset}`);
  const data = await res.json();
  rawBox.textContent = JSON.stringify(data,null,2);

  if(!data.success){
    statusEl.textContent = "Batch failed";
    return;
  }

  updateSummary(data);
  renderTable(data.results);
  statusEl.textContent = "Completed";
});
</script>
</body>
</html>
