<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Predictive-v7 — Strategic Risk Intelligence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#f7f7f8; }
    .chip { padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; }
    .index-box { border-radius:14px; background:white; padding:18px 20px; }
  </style>
</head>

<body class="min-h-screen">

  <div class="max-w-6xl mx-auto py-10 px-6">

    <h1 class="text-3xl font-bold mb-2">
      Predictive-v7 — Strategic Risk Intelligence
    </h1>

    <p class="text-gray-600 mb-6">
      Posture × Capability modeling across vertical ecosystems.<br>
      Measures resilience, exposure, fragility, and structural drift risk.
    </p>

    <!-- Selector -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
      <label class="block text-xs font-semibold text-gray-600 uppercase mb-2">
        Select Vertical Dataset
      </label>

      <div class="flex gap-3">
        <select id="datasetSelect"
          class="border rounded-lg px-3 py-2 text-sm bg-white w-full">
          <option>Loading…</option>
        </select>

        <button id="runBtn"
          class="px-4 py-2 bg-black text-white rounded-lg text-sm">
          Run Predictive
        </button>
      </div>

      <div id="status" class="text-xs text-gray-500 mt-2"></div>
    </div>

    <!-- RESULTS -->
    <div id="results" class="hidden space-y-8">

      <!-- HEADER SNAPSHOT -->
      <div class="grid grid-cols-2 md:grid-cols-6 gap-4">

        <div class="index-box">
          <div class="text-xs text-gray-500 uppercase">Dataset</div>
          <div id="dsName" class="text-lg font-semibold">—</div>
        </div>

        <div class="index-box">
          <div class="text-xs text-gray-500 uppercase">Sites</div>
          <div id="dsSites" class="text-lg font-semibold">0</div>
        </div>

        <div class="index-box">
          <div class="text-xs text-gray-500 uppercase">Avg ECC</div>
          <div id="dsECC" class="text-lg font-semibold">0.00</div>
        </div>

        <div class="index-box">
          <div class="text-xs text-gray-500 uppercase">Resilience</div>
          <div id="idxRes" class="text-lg font-semibold">0.00</div>
        </div>

        <div class="index-box">
          <div class="text-xs text-gray-500 uppercase">Exposure</div>
          <div id="idxExp" class="text-lg font-semibold">0.00</div>
        </div>

        <div class="index-box">
          <div class="text-xs text-gray-500 uppercase">Fragility</div>
          <div id="idxFrag" class="text-lg font-semibold">0.00</div>
        </div>

      </div>

      <!-- Risk Status -->
      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-xl font-bold mb-2">Predictive Assessment</h2>
        <p class="text-sm text-gray-700">
          <strong>Risk Band:</strong> <span id="riskBand"></span><br>
          <strong>Trajectory:</strong> <span id="trajectory"></span>
        </p>
      </div>

      <!-- MATRIX -->
      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-xl font-bold mb-4">Posture × Capability Matrix</h2>

        <table class="w-full text-sm">
          <thead>
            <tr class="text-gray-500">
              <th class="text-left py-1">Bucket</th>
              <th class="text-left py-1">Count</th>
            </tr>
          </thead>
          <tbody id="matrixTable"></tbody>
        </table>
      </div>

      <!-- ANCHORS / RISKS / BREAKPOINTS -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-lg font-semibold mb-3">Strategic Anchors</h3>
          <ul id="anchorList" class="space-y-1 text-sm text-gray-700"></ul>
        </div>

        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-lg font-semibold mb-3">Structural Risk Nodes</h3>
          <ul id="riskList" class="space-y-1 text-sm text-gray-700"></ul>
        </div>

        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-lg font-semibold mb-3">Breakpoints (Repairable)</h3>
          <ul id="breakList" class="space-y-1 text-sm text-gray-700"></ul>
        </div>

      </div>

      <!-- UPGRADE LEVERAGE TARGETS -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-lg font-semibold mb-3">
            High-ROI Upgrade Targets
          </h3>
          <ul id="leverageHigh" class="space-y-2 text-sm text-gray-700"></ul>
        </div>

        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-lg font-semibold mb-3">
            Quick-Win Repairables
          </h3>
          <ul id="leverageQuick" class="space-y-2 text-sm text-gray-700"></ul>
        </div>

      </div>

      <!-- NOTES -->
      <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-lg font-semibold mb-2">Analyst Notes</h3>
        <ul id="notesList" class="list-disc pl-6 text-gray-700 text-sm"></ul>
      </div>

    </div>
  </div>


<script>
const els = {
  sel: document.getElementById("datasetSelect"),
  btn: document.getElementById("runBtn"),
  status: document.getElementById("status"),
  results: document.getElementById("results"),

  dsName: document.getElementById("dsName"),
  dsSites: document.getElementById("dsSites"),
  dsECC: document.getElementById("dsECC"),

  idxRes: document.getElementById("idxRes"),
  idxExp: document.getElementById("idxExp"),
  idxFrag: document.getElementById("idxFrag"),

  riskBand: document.getElementById("riskBand"),
  trajectory: document.getElementById("trajectory"),

  matrixTable: document.getElementById("matrixTable"),
  anchorList: document.getElementById("anchorList"),
  riskList: document.getElementById("riskList"),
  breakList: document.getElementById("breakList"),

  leverageHigh: document.getElementById("leverageHigh"),
  leverageQuick: document.getElementById("leverageQuick"),

  notesList: document.getElementById("notesList")
};

/* Load Verticals */
async function loadVerticals(){
  try{
    const res = await fetch("/api/verticals");
    const data = await res.json();
    els.sel.innerHTML = "";
    data.verticals.forEach(v=>{
      const o=document.createElement("option");
      o.value=v.value; o.textContent=v.label;
      els.sel.appendChild(o);
    });
  } catch(e){
    els.sel.innerHTML="<option>Error loading</option>";
  }
}
loadVerticals();

/* Run Predictive-v7 */
els.btn.onclick = async () => {
  const dataset = els.sel.value;
  els.btn.disabled = true;
  els.btn.textContent = "Running…";
  els.status.textContent = "Running batch…";

  try {
    const batch = await (await fetch(`/api/batch-run?dataset=${dataset}`)).json();
    els.status.textContent = "Running predictive…";

    const pred = await (await fetch("/api/predictive-audit", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ dataset, results: batch.results })
    })).json();

    render(pred, dataset);

  } catch(e){
    alert("Predictive run failed.");
  } finally {
    els.btn.disabled=false;
    els.btn.textContent="Run Predictive";
  }
};

/* Render */
function render(data, dataset){
  els.results.classList.remove("hidden");

  const { stats, indexes, notes, leverage } = data;

  els.dsName.textContent = dataset;
  els.dsSites.textContent = stats.totalSites;
  els.dsECC.textContent = stats.avgECC.toFixed(2);

  els.idxRes.textContent = indexes.resilience.toFixed(2);
  els.idxExp.textContent = indexes.exposure.toFixed(2);
  els.idxFrag.textContent = indexes.fragility.toFixed(2);

  els.riskBand.textContent = indexes.riskBand;
  els.trajectory.textContent = indexes.trajectory;

  els.matrixTable.innerHTML = Object.entries(stats.matrix)
    .map(([k,v])=>`<tr><td class="py-1">${k}</td><td>${v}</td></tr>`)
    .join("");

  els.anchorList.innerHTML = stats.anchors
    .map(x=>`<li>${x.url} — ${x.ecc}</li>`).join("");

  els.riskList.innerHTML = stats.risks
    .map(x=>`<li>${x.url} — ${x.ecc}</li>`).join("");

  els.breakList.innerHTML = stats.breakpoints
    .map(x=>`<li>${x.url} — ${x.ecc}</li>`).join("");

  /* Upgrade Leverage Targets */
  els.leverageHigh.innerHTML =
    leverage.highROI.length
      ? leverage.highROI.map(x =>
          `<li>
            <span class="font-medium">${x.url}</span> — ${x.ecc}
            <div class="text-gray-500">${x.rationale}</div>
          </li>`
        ).join("")
      : `<li class="text-gray-400">None detected</li>`;

  els.leverageQuick.innerHTML =
    leverage.quickWins.length
      ? leverage.quickWins.map(x =>
          `<li>
            <span class="font-medium">${x.url}</span> — ${x.ecc}
            <div class="text-gray-500">${x.rationale}</div>
          </li>`
        ).join("")
      : `<li class="text-gray-400">None detected</li>`;

  els.notesList.innerHTML =
    notes.map(n=>`<li>${n}</li>`).join("");
}
</script>

</body>
</html>
